var editor_ckedit5=[],selectionItem="",currentLockBox=null;function addCkeditor(t,e=0){let i=".editor_"+t;$("body").on("click",`#${t}_rewrite_box .btn-go`,(()=>{let e=$(`#${t}_rewrite_box .type-rewrite`).val();n(e)})),$("body").on("click",`#${t}_rewrite_box .redo`,(()=>{let e=$(`#${t}_rewrite_box .current-type`).val();n(e)})),$("body").on("click",`#${t}_rewrite_box .option .copy`,(t=>{let e=$(t.target);(t=>{let e=$(t).text();if(navigator.clipboard)navigator.clipboard.writeText(e);else{var i=$("<input>");$("body").append(i),i.val(e).select(),document.execCommand("copy")||Clipboard.copy(e),i.remove()}})(e.closest(".option").find(".option_body").html().trim()),e.find("span").text("Đã copy")})),$("body").on("click",`#${t}_rewrite_box .option .insert`,(e=>{let i=$(e.target),o=i.closest(".option"),n=o.data("type");((e,i=0)=>{let o=window.editor[t];o.model.change((t=>{let n=o.data.processor.toView(e),r=o.data.toModel(n);i?o.model.insertContent(r):o.model.insertContent(r,o.model.document.selection.getLastPosition())})),o.editing.view.focus(),o.editing.view.scrollToTheSelection()})(o.find(".option_body").html().trim(),"write"==n?0:1),i.find("span").text("Đã Chèn")}));let o=$(`.editor_${t}`).offset().top;jQuery(window).scroll((function(){let e=jQuery(window).scrollTop(),i=o+$(`.editor_${t}`).height(),n=$(`#${t}_rewrite_box`),r=n.height();e<o?n.css({position:"relative"}):e+r>=i?n.css({position:"absolute",top:i-r-o,right:10,left:10}):n.css({position:"absolute",top:e-o+10,right:10,left:10})}));const n=e=>{const i=()=>{let e=window.editor[t].getData()||$(`textarea[name="${field_detail}"]`).val();return $("<div></div>").html(e)},o=(e=1)=>{if($(`#${t}_rewrite_box .rewrite_result_list .item_loading`).remove(),e){let e='<div class="option item_loading">\n                                <svg aria-labelledby="xyrsghc-aria" role="img" width="100%" height="100%" viewBox="0 0 340 84"><title id="xyrsghc-aria">Loading...</title><rect role="presentation" x="0" y="0" width="100%" height="100%" clip-path="url(#xyrsghc-diff)" style="fill: url(&quot;#xyrsghc-animated-diff&quot;);"></rect><defs><clipPath id="xyrsghc-diff"><rect x="0.541992" y="0.28125" width="100%" height="10.7675" fill="#D9D9D9"></rect><rect x="0.541992" y="41.394" width="100%" height="10.7675" fill="#D9D9D9"></rect><rect x="0.541992" y="20.8374" width="90%" height="10.7675" fill="#D9D9D9"></rect><rect x="0.541992" y="61.9502" width="90%" height="10.7675" fill="#D9D9D9"></rect></clipPath><linearGradient id="xyrsghc-animated-diff"><stop offset="0%" stop-color="#f3f3f3" stop-opacity="1"><animate attributeName="offset" values="-2; -2; 1" keyTimes="0; 0.25; 1" dur="2s" repeatCount="indefinite"></animate></stop><stop offset="50%" stop-color="#ecebeb" stop-opacity="1"><animate attributeName="offset" values="-1; -1; 2" keyTimes="0; 0.25; 1" dur="2s" repeatCount="indefinite"></animate></stop><stop offset="100%" stop-color="#f3f3f3" stop-opacity="1"><animate attributeName="offset" values="0; 0; 3" keyTimes="0; 0.25; 1" dur="2s" repeatCount="indefinite"></animate></stop></linearGradient></defs></svg>\n                            </div>\n                            <div class="option item_loading">\n                                <svg aria-labelledby="xyrsghc-aria" role="img" width="100%" height="100%" viewBox="0 0 340 84"><title id="xyrsghc-aria">Loading...</title><rect role="presentation" x="0" y="0" width="100%" height="100%" clip-path="url(#xyrsghc-diff)" style="fill: url(&quot;#xyrsghc-animated-diff&quot;);"></rect><defs><clipPath id="xyrsghc-diff"><rect x="0.541992" y="0.28125" width="100%" height="10.7675" fill="#D9D9D9"></rect><rect x="0.541992" y="41.394" width="100%" height="10.7675" fill="#D9D9D9"></rect><rect x="0.541992" y="20.8374" width="90%" height="10.7675" fill="#D9D9D9"></rect><rect x="0.541992" y="61.9502" width="90%" height="10.7675" fill="#D9D9D9"></rect></clipPath><linearGradient id="xyrsghc-animated-diff"><stop offset="0%" stop-color="#f3f3f3" stop-opacity="1"><animate attributeName="offset" values="-2; -2; 1" keyTimes="0; 0.25; 1" dur="2s" repeatCount="indefinite"></animate></stop><stop offset="50%" stop-color="#ecebeb" stop-opacity="1"><animate attributeName="offset" values="-1; -1; 2" keyTimes="0; 0.25; 1" dur="2s" repeatCount="indefinite"></animate></stop><stop offset="100%" stop-color="#f3f3f3" stop-opacity="1"><animate attributeName="offset" values="0; 0; 3" keyTimes="0; 0.25; 1" dur="2s" repeatCount="indefinite"></animate></stop></linearGradient></defs></svg>\n                            </div>';$(`#${t}_rewrite_box .rewrite_result_list`).prepend(e)}},n=e=>{let i=`<div class="option">\n                            <div class="option_header">\n                                <span>Lỗi</span>\n                            </div>\n                            <div class="option_body">\n                                <p class="error">${e}</p>\n                            </div>\n                        </div>`;$(`#${t}_rewrite_box .rewrite_result_list`).prepend(i)};let r=$(`#${t}_rewrite_box`);r.find("input.current-type").val(e);let a=r.find("input.selected-text").val(),l=(t=>{let e=i().html(),o=e.indexOf(t);if(-1==o)return"";let n=e.substring(0,o),r=(new DOMParser).parseFromString(n,"text/html").querySelectorAll("h1, h2, h3, h4, h5, h6");return r.length?r[r.length-1].textContent:""})(a),d=r.data("field_title"),s=$(`input[name="${d}"`).val().trim(),c=(()=>{let t=i().find("h1, h2, h3, h4, h5, h6");return $.map(t,((t,e)=>t.outerHTML)).join(" ")})();console.log("Bắt đầu viết bài chatgpt"),o(),r.find(".rewrite_result_list").animate({scrollTop:0},"slow"),$.ajax({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},type:"POST",data:{type:e,text:a,title:s,heading:l,outline:c},url:"/admin/ajax/getRewriteContentFromChatGPT",success:function(i){1==i.success?(data=i.data,ans=data.answer,((e,i)=>{let o="";e.forEach(((t,e)=>{let n=`Option ${e+1}`;t=t.trim().replace("\r","").replace("\n\n","<br />").replace("\n","<br />"),o+=`<div class="option" data-type="${i}">\n                            <div class="option_header">\n                                <span>${n}</span>\n                            </div>\n                            <div class="option_body">\n                                ${t}\n                            </div>\n                            <div class="option_footer">\n                                <div class="option_footer__tool insert">\n                                    <i class="fa fa-arrow-circle-o-left"></i> Insert\n                                </div>\n                                <div class="option_footer__tool copy">\n                                    <i class="fa fa-copy"></i> Copy\n                                </div>\n                            </div>\n                        </div>`})),$(`#${t}_rewrite_box .rewrite_result_list`).prepend(o)})(ans,e)):n(i.message),o(!1),r.find(".rewrite_box__header__bottom").hide(),console.log("Hoàn tất viết bài chatgpt")},error:function(t){r.find(".rewrite_box__header__bottom").hide(),n(t),o(!1),console.log("Hoàn tất viết bài chatgpt")}})};let r={dnvImage:()=>{admin_dir=$("meta[name=admin_dir]").attr("content"),url_media="/"+admin_dir+"/media?uploads=ckeditor&field_id="+t+"&only=image",$("#media").find("iframe").attr("src",url_media),$("#media").modal("toggle")},dnvCKToc:()=>{$("body").append('<div id="tocList" style="display: none;"></div>');let e=null,o=null;setTimeout((()=>{$(i+" .ck-restricted-editing_mode_standard h2, "+i+" .ck-restricted-editing_mode_standard h3").each((function(){let t=(new Date).getTime();if(""!=$(this).text()&&null!=$(this).text())if($(this).is("h2")){$(this).attr("id","metoc_"+t);let i="<li class='has_child'><span><i class='fas fa-angle-down'></i></span><a href='#metoc_"+t+"'>"+$(this).text()+"</a></li>";o=$("<ul></ul>"),e=$(i),e.append(o),e.appendTo("#tocList")}else{$(this).attr("id","metoc_"+t);let e="<li><a href='#metoc_"+t+"'>"+$(this).text()+"</a></li>";null!==o&&o.append(e)}})),$("#tocList li.has_child ul").each((function(){$(this).find("li").length<=0&&$(this).remove()}));let n=$("#tocList").html();if(""!=n){let e=`<div class="mce-toc"><p class="mce-toc-title"><span style="margin: 4px;">Mục lục</span></p><ul>${n} </ul></div>`;window.editor[t].model.change((i=>{let o=window.editor[t].data.processor.toView(e),n=window.editor[t].data.toModel(o);window.editor[t].model.insertContent(n,window.editor[t].model.document.selection)})),html=$(i+" .ck-restricted-editing_mode_standard").html(),window.editor[t].execute("selectAll"),window.editor[t].setData(html)}}),200),setTimeout((()=>{$("body #tocList").remove()}),240)},aiAutoContentWrite:()=>{let e=window.editor[t],i=e.data.stringify(e.model.getSelectedContent(e.model.document.selection)),o=$(`#${t}_rewrite_box`);o.show(),o.find("input.selected-text").val(i),n("write"),o.find(".rewrite_box__header .title").html('\n            <i class="fa fa-pencil"></i> Viết thêm\n        '),o.find(".rewrite_box__header__bottom").hide()},aiAutoContentRewrite:()=>{let e=window.editor[t],i=e.data.stringify(e.model.getSelectedContent(e.model.document.selection)),o=$(`#${t}_rewrite_box`);o.show(),o.find("input.selected-text").val(i),o.find(".rewrite_box__header .title").html('\n            <i class="fa fa-paint-brush"></i> Viết lại </span>\n        '),o.find(".rewrite_box__header__bottom").show()},aiAutoContentDescribe:()=>{alert("Đang phát triển")},simpleUpload:{uploadUrl:"/admin/media/upload-from-editor",withCredentials:!1,types:["png","jpeg","jpg","svg","gif"]}};e&&(r.toolbar={items:[...ClassicEditor.defaultConfig.toolbar.items,"|","auto_content_write","auto_content_rewrite"],shouldNotGroupWhenFull:!0}),ClassicEditor.create(document.querySelector("#"+t),r).then((e=>{editor_ckedit5[t]=e,window.editor=editor_ckedit5;let i=e.plugins.get("WordCount");document.getElementById(t+"_count").appendChild(i.wordCountContainer)})).catch((t=>{console.warn("Init ckeditor error"),console.error(t)}))}
